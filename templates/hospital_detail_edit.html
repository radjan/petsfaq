
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <title>Bootstrap, from Twitter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/s/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
    <link href="/s/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/s/css/myFormat.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/s/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/s/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/s/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/s/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="/s/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="/s/ico/favicon.png">

  </head>

  <body>

 {% include 'components/navbar.html' %}
    <div class="container-fluid">
      <div class="row-fluid">
        {% include 'components/side_editMode.html' %}
        <div class="span10">
          <div class="accordion" id="accordion2">
             <div class="accordion-group">
                <div class="accordion-heading">
                  <a name="hLists" class="accordion-toggle"> Hopital Lists > </a>
                </div>
              </div>
           
          </div><!--/accordion-->

          <div class="hero-unit">
            <button id="edit_hospital" type="button" class="btn btn btn-warning edit_type edit_button right">
                <i class="icon-pencil"></i>
            </button>
            <button id="create_post" type="button" class="btn btn btn-info edit_type edit_button right">
                <i class="icon-file"></i>
            </button>

            <div class="right">
              <button id="save_hospital" type="button" class="btn btn btn-info edit_type">
                  <i class="icon-hdd icon-white"></i>
              </button>
              <button id="cancel_hospital" type="button" class="btn btn-mini edit_type btn-reverse">
                  <i class="icon-remove"></i>
              </button>
            </div>
            <h1><span id="hospital_name" class="browse_type"><!--hospital name--></span>
              <input id="edit_hospital_name" type="text" class="edit_type">
            </h1>
            <p>
              <span id="hospital_desc" class="browse_type"><!-- hospital description --></span>
              <textarea id="edit_hospital_desc" rows="5" class="input-block-level edit_type"></textarea>
            </p>
            <p>
              <span>醫院專科</span>
              <span id="hospital_specialties" class="browse_type"></span>
              <ul id='edit_hospital_Specialties' class="edit_type"></ul>
            </p>
            <p>
              <span>地址：</span>
              <span id="hospital_address_all" class="browse_type"></span>
               <div id="hospital_address" class="hidden"></div>
               <div id="edit_hospital_address_all" class="edit_type">
                    <select id="selector_county" name="county">
                      <option value=''>選擇縣市</option>
                    <!-- <input name="county" type="text" class="input-block-level"><br> -->
                    </select>
                    <select id="selector_area" name="area">
                    <option value=''>選擇鄉鎮市區</option>
                    <!-- 鄉鎮市區：<input name="area" type="text" class="input-block-level"><br> -->
                    </select>
                    <br>
                    <input id="input_zipCode" name="zipcode" type="hidden">
                    <input id="edit_hospital_address" type="text" class="input-block-level"><br>
                </div>
            </p>
            <p>
              <span>電話：</span>
              <span id="hospital_phone" class="browse_type"></span>
              <input id="edit_hospital_phone" type="text" class="input-block-level edit_type">
            </p>
            <p>
              <span>看診時間：</span>
              <span id="hospital_working_hour" class="browse_type"></span>
              <textarea id="edit_hospital_working_hour" class="input-block-level edit_type"></textarea>
            </p>
            <p>
              <span>急診電話：</span>
              <span id="hospital_er_phone" class="browse_type"></span>
              <input id='edit_hospital_er_phone' type="text" class="input-block-level edit_type">
              <br>
              <span>急診時間：</span>
              <span id="hospital_er_hours" class="browse_type"></span>
              <textarea id='edit_hospital_er_hour' type="text" class="input-block-level edit_type"></textarea>
            </p>
            <p>
              <span>統一編號：</span>
              <span id="hospital_value_added_tax" class="browse_type"></span>
              <input id="edit_value_added_tax" type="text" class="input-block-level edit_type"><br>
            </p>
          </div>
          
          
          <hr class="bs-docs-separator">

          <div class="row-fluid">

            <div class="container-fluid" id="vets">
              <!-- place for vets -->
            </div><!-- /container -->
            <hr class="bs-docs-separator">

        </div><!--/span-->
      </div><!--/row-->

      <hr>

      <footer>
        <p>&copy; Company 2013</p>
      </footer>

    </div><!--/.fluid-container-->

    <div class="templates">
        <div class="row-fluid browse_type" name="oneVet">
            <div class="right">
              <button id="editVet_" type="button" class="btn btn btn-warning edit_type edit_button">
                  <i class="icon-pencil"></i>
              </button>
               <button id="vet_create_post_" type="button" class="btn btn btn-info edit_type edit_button">
                <i class="icon-file"></i>
              </button>
              <button id="deleteVet_" type="button" class="btn btn-mini edit_type edit_button">
                  <i class="icon-trash"></i>
              </button>
            </div>
            <div class="right">
              <button id="saveVet_" type="button" class="btn btn btn-info edit_type">
                  <i class="icon-hdd icon-white"></i>
              </button>
              <button id="cancelVet_" type="button" class="btn btn-mini edit_type">
                  <i class="icon-remove"></i>
              </button>
            </div>
            

            <div class="span2">
              <img src="/s/img/tmpPic.png" class="img-polaroid" style="margin-top:15px">
            </div>
            <div class="span8">
              <h2><span name="vet_name"><!-- vet name --></span>
                  <!-- <input tsype="text" class="edit_type" name="vet_name"> -->
                  <small><a href="#">Blog</a></small>
              </h2> 
              <p><span name="vet_desc"><!-- vet desc --></span>
                  <textarea name="vet_desc" rows="5" class="input-block-level edit_type"></textarea>
              </p>
              <dl>
                <dt>學經歷</dt>
                <div name="exp"></div>
                <div name="edit_exp" class="edit_type"></div>
                <div name="edu"></div>
                <div name="edit_edu" class="edit_type"></div>
              </dl>
              <dl name="specialty">
                <dt>專長</dt>
              </dl>
              <ul id='vetSpecialties_' class="edit_type"></ul>
              <button type="button" class="btn btn-info" data-target="#nameCard_" data-toggle="collapse">
              <!-- <button class="btn btn-info" name="nameCardBtn_"> -->
                    名片
              </button>
             
              <div id="nameCard_" class="collapse">
                <address>
                  <br>
                  <strong><span name="vet_name">vet name</span></strong><br>
                    <a href="mailto:#"><span name="vet_mail">vet@mail</span></a>
                    <!-- <input type="text" class="edit_type" name="vet_mail"><br> -->

                    <span name="hospital_name"><!-- hospital name --></span><br>
                    看診時間：9:00-21:00 <br>
                    電話：<span class='phone'><!-- hospital phone --></span><br>
                    地址：<span class='address'><!-- hopital address --></span><br>
                    <ul>
                      <li>可預約、可急診</li>
                      <li>急診條件：20:00-24:00</li>
                    </ul>
                </address>

              </div>
            </div><!--/span-->
        </div><!--/row-->
    </div>

    <div id='templates' class='templates specialtySelector'>
     <li name='spec_item'>
       <label>種類：</label>
       <select name='species_' class='species'>
          <option value=''>未選擇</option>
       </select>
       <input name="newSpecies" type="text" placeholder="新增種類" class="input-block-level inputNewSpecies">
       <label>專科：</label>
       <select name='category_' class='category'>
          <!-- <option value='一般' class="optionCategory">一般</option> -->
       </select>
       <input name="newCategory" type="text" placeholder="新增專科" class="input-block-level inputNewCategory">
       <!-- <textarea class="inputNewCategory" rows="1" autofocus></textarea> -->
     </li> 
   </div>

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.1.1.min.js"></script>
    <script src="/s/js/bootstrap.js"></script>
    <script src="/s/js/showNAddSpecialites.js"></script>
    <script src="/s/js/twzipcode.js"></script>
    <script src="/s/js/common/common_util.js"></script>

    <script type="text/javascript">
    $(document).ready(function(){
        
        var hid = window.location.pathname.split("/")[2];
        $.ajax({
            url: "/api/v1/hospital/" + hid,
            type: "GET",
            cache: false
        }).done(function (data) { putData(data); });

        
        $(".browse_type").show();
        $(".edit_type").hide();
        $(".edit_button").show();

        $("#edit_hospital").click(function(){
          $("#edit_hospital").hide();
          $("#create_post").hide();
          $("#save_hospital").show();
          $("#cancel_hospital").show();

          $("#hospital_specialties").hide();

          $("#edit_hospital_name").attr("placeholder",$("#hospital_name").text()).show();
          $("#edit_hospital_desc").attr("placeholder", $("#hospital_desc").text()).show();
          $("#edit_hospital_address").attr("placeholder", $("#hospital_address").text()).show();
          $("#edit_hospital_phone").attr("placeholder",$("#hospital_phone").text()).show();
          $("#edit_hospital_working_hour").attr("placeholder",$("#hospital_working_hour").text()).show();
          $("#edit_hospital_Specialties").show();
          $("#edit_hospital_address_all").show();
          $("#edit_hospital_er_phone").attr("placeholder",$("#hospital_er_phone").text()).show();
          $("#edit_hospital_er_hour").attr("placeholder",$("#hospital_er_hours").text()).show();
          $("#edit_value_added_tax").attr("placeholder",$("#hospital_value_added_tax").text()).show();
        });

        $("#create_post").click(function(){
          location.href = "/new_post?hid="+hid;
        });
    

        $("#save_hospital").click(function(){
          var _hasEr = false;
          var _request = {};

          if( $("#edit_hospital_name").val() != ""){
            $("#hospital_name").text($("#edit_hospital_name").val());
            _request["name"] = $("#hospital_name").text();
          }
          if($("#edit_hospital_desc").val() != ""){
            $("#hospital_desc").text($("#edit_hospital_desc").val());
            _request["description"] = $("#hospital_desc").text();
          }
          if($("#edit_hospital_address").val() != ""){
            $("hospital_address").text($("#edit_hospital_address").val());
            _request["address"] = $("#hospital_address").text();
          }
          if($("#edit_hospital_phone").val() != ""){
            $("#hospital_phone").text($("#edit_hospital_phone").val());
            _request["phone"] =  $("#hospital_phone").text();
          }
          if($("#edit_hospital_working_hour").val() != ""){
            $("#hospital_working_hour").text($("edit_hospital_working_hour").val());
            _request["working_hour"] = $("#hospital_working_hour").text();
          }
          if($("#edit_hospital_er_phone").val() != ""){
            $("#hospital_er_phone").text($("#edit_hospital_er_phone").val());
            _hasEr = true;
            _request["emergency_phone"] = $("#hospital_er_phone").text();
          }
          if($("#edit_hospital_er_hour").val() != ""){
            $("#hospital_er_hours").text($("#edit_hospital_er_hour").val());
            _hasEr = true;
            _request["emergency_hour"] = $("#hospital_er_hours").text();
          }
          if($("#edit_value_added_tax").val() != ""){
            $("hospital_value_added_tax").text($("#edit_value_added_tax").val());
            _request["value_added_tax"] = $("hospital_value_added_tax").text();
          }

          _request["emergency"] = _hasEr;
          _request["area"] = $("#selector_area").val();
          _request["zipcode"] = $("#input_zipCode").val();
          _request["county"] = $("#selector_county").val();

          var speciesArray= new Array();
          for (var i = 1; i < 4; i++) {
            var tmpS = $("#edit_hospital_Specialties").find("*[name=species_"+i+"]");
            if(tmpS.val() != ""){
              var _sMap = {"species": tmpS.val(), "category":$("*[name=category_"+i+"]").val()};
              speciesArray.push(_sMap);
            }
          }
          _request["specialties"] = speciesArray;

          $.ajax({
            url: "/api/v1/hospital/"+hid,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(_request),
            cache: false
          }).done(cancelHospital());
        });

        $("#cancel_hospital").click(function(){cancelHospital()});
    });

    function cancelHospital(){
          $("#edit_hospital").show();
          $("#create_post").show();
          $("#save_hospital").hide();
          $("#cancel_hospital").hide();

          $("#hospital_specialties").show();

          $("#edit_hospital_name").hide();
          $("#edit_hospital_desc").hide();
          $("#edit_hospital_address").hide();
          $("#edit_hospital_phone").hide();
          $("#edit_hospital_working_hour").hide();
          $("#edit_hospital_Specialties").hide();
          $("#edit_hospital_address_all").hide();
          $("#edit_hospital_er_phone").hide();
          $("#edit_hospital_er_hour").hide();
          $("#edit_value_added_tax").hide();
      
          $("#edit_hospital_name").val("");
          $("#edit_hospital_desc").val("");
          $("#edit_hospital_address").val("");
          $("#edit_hospital_phone").val("");
          $("#edit_hospital_working_hour").val("");
          $("#edit_hospital_er_phone").val("");
          $("#edit_hospital_er_hour").val("");
          $("#edit_value_added_tax").val("");
    }

    function putData(hospital) {
      $("#hospital_name").text(hospital.name);
      $("#hospital_desc").text(hospital.description);
      $("#hospital_address_all").text(hospital.zipcode+" "+hospital.county+hospital.area+hospital.address);
      $("#hospital_address").text(hospital.address);
      $("#hospital_phone").text(hospital.phone);
      $("#hospital_working_hour").text(hospital.working_hour);
      $("#hospital_value_added_tax").text(hospital.value_added_tax);

      // set specialties edit
      var _showSpecialty = "<ul>";
      for (var i in hospital.specialties) {
        var _specialty = hospital.specialties[i].specialty;
        _showSpecialty += "<li>" + _specialty.species;
        _showSpecialty += ":" + _specialty.category + "</li>";
      }
      _showSpecialty += "</ul>";
      $("#hospital_specialties").html(_showSpecialty);
      initSpecialtiesSelection($("#edit_hospital_Specialties"), hospital.specialties.length+1, hospital.specialties);


      //set address edit
      for (var county in TW_ZIP) {
         $("#selector_county").append('<option value="' + county+ '">' + county + '</option>');
      }

      $("#selector_county").val(hospital.county);
      showArea($("#selector_county").val());
      $("#selector_area").val(hospital.area);
      
      $("#selector_county").change(function(){
          showArea($("#selector_county").val());
      });

      $("#selector_area").change(function(){
        var county = $("#selector_county").val();
        var area = $("#selector_area").val();
        $("#input_zipCode").val(TW_ZIP[county][area]);
      });

      // set hospital emergency edit
      // if(hospital.emergency == "True"){
        $("#hospital_er_phone").text(hospital.emergency_phone);
        $("#hospital_er_hours").text(hospital.emergency_hour);
      // }else{
        // $("#hospital_has_er").hide();
      // }


     
      updateVets(hospital);

    }

    function updateVets(hospital){
      var vets = $("#vets");
      vets.empty();
      var vs = hospital.vets
      for (i in vs){
          var v = $("div[name=oneVet]").last().clone();
          v.find("span[name=hospital_name]").text(hospital.name);
          v.find("span.phone").text(hospital.phone);
          v.find("span.address").text(hospital.zipcode +
                                      hospital.county +
                                      hospital.area +
                                      hospital.address);
          v.find("span[name=vet_name]").text(vs[i].person.name);
          v.find("span[name=vet_desc]").text(vs[i].description);
          v.find("span[name=vet_mail]").text(vs[i].person.email);

          for (j in vs[i].experience) {
            v.find("div[name=exp]").append("<dd>"+vs[i].experience[j]+"</dd>");
            v.find("div[name=edit_exp]").append("<dd><input name='exp_"+j+"' type='text' value='"+vs[i].experience[j]+"' class='input-block-level'></dd>");
          }
          v.find("div[name=edit_exp]").append("<dd><input name='exp_"+vs[i].experience.length+"' type='text' class='input-block-level'></dd>");

          for (j in vs[i].education) {
            v.find("div[name=edu]").append("<dd>"+vs[i].education[j]+"</dd>");
            // v.find("div[name=edit_edu]").append("<dd>"+vs[i].education[j]+"</dd>");
            v.find("div[name=edit_edu]").append("<dd><input name='edu_"+j+"' type='text' value='"+vs[i].education[j]+"' class='input-block-level'></dd>");
          }
          v.find("div[name=edit_edu]").append("<dd><input name='edu_"+vs[i].education.length+"' type='text' class='input-block-level'></dd>");

          // alert(initSpecialties(1));
          for (j in vs[i].specialties) {
            // alert("j: "+j);
            v.find("dl[name=specialty]").append("<dd>"+vs[i].specialties[j].specialty.species+": "+vs[i].specialties[j].specialty.category+"</dd>");

          }
          initSpecialtiesSelection(v.find("#vetSpecialties_"), vs[i].specialties.length+1, vs[i].specialties);
          
          setBtn(v, i, vs[i]);
          vets.append(v);
      }
    }

    function setBtn(v, i, vet) {
      //set name card.
      var _nameCardBtn = v.find("button[data-target=#nameCard_]");
      var _nameCard = v.find("#nameCard_");
      var _vetSpecialties = v.find("#vetSpecialties_");

      _nameCardBtn.attr("data-target", "#nameCard_"+i);
      _nameCard.attr("id", "nameCard_"+i);
      _vetSpecialties.attr("id", "vetSpecialties_"+i);

      // for (j in v.experience) {
      //   v.find("dl[name=exp]").append("<dd>"+v.experience[j]+"</dd>");
      // }
      // for (j in v.education) {
      //   v.find("dl[name=exp]").append("<dd>"+v.education[j]+"</dd>");
      // }
      // for (j in v.specialties) {
      //   v.find("dl[name=specialty]").append("<dd>"+vs.specialties[j].species+": "+v.specialties[j].category+"</dd>");
      // }   

      //set edit
      var _editVet = v.find("#editVet_");
      var _vetCreatePost = v.find("#vet_create_post_");
      var _deleteVet = v.find("#deleteVet_");
      var _saveVet = v.find("#saveVet_");
      var _cancelVet = v.find("#cancelVet_");
      _editVet.attr("id", "editVet_"+i);
      _vetCreatePost.attr("id", "vet_create_post_"+i);
      _deleteVet.attr("id", "deleteVet_"+i);
      _saveVet.attr("id", "saveVet_"+i);
      _cancelVet.attr("id", "cancelVet_"+i);

      _editVet.click(function(){
        // v.find("input[name=vet_name]").show();
        v.find("textarea[name=vet_desc]").show();
        v.find("div[name=edit_exp]").show();
        v.find("div[name=edit_edu]").show();
        // v.find("input[name=vet_mail]").show();
        _vetSpecialties.show();
        _nameCard.removeClass("collapse");
        _nameCardBtn.attr("disabled", true);

        _editVet.hide();
        _vetCreatePost.hide();
        _deleteVet.hide();
        _saveVet.show();
        _cancelVet.show();
      });

      _vetCreatePost.click(function(){
        var s = "/new_post?hid="+vet.hospital+"&pid="+vet.person.id;
        location.href = s;
      });

      _deleteVet.click(function(){
        //TODO:
      });

      _saveVet.click(function(){saveVet(v, i, vet)});

      _cancelVet.click(function(){cancelVet(v, i, vet)});
    }

    function saveVet(v, i, vet){
        //FIXME:
          var _request = {};
          var _exp_array = new Array();
          var _edu_array = new Array();

          var _vet_desc = v.find("textarea[name=vet_desc]").val();
          if(_vet_desc != ""){
            v.find("span[name=vet_desc]").text(_vet_desc);
            _request["description"] = _vet_desc;
          }

          for (var i = 0; i < vet.experience.length+1; i++) {
            var _vet_exp = v.find("input[name=exp_"+i+"]").val();
            if(_vet_exp != ""){
              _exp_array.push(_vet_exp);
            }
          };
          _request["experience"] = _exp_array;

          for (var i = 0; i < vet.education.length+1; i++) {
            var _vet_edu = v.find("input[name=edu_"+i+"]").val();
            if(_vet_edu != ""){
              _edu_array.push(_vet_edu);
            }
          };
          _request["education"] = _edu_array;          

          var _showSpecialty = new Array();
          for (var i = 1; i < 4; i++) {
            var _species = v.find("*[name=species_"+i+"]");
            var _sMap = {};
            if(_species.val() != ""){
              _sMap["species"] = _species.val();
              _sMap["category"] = $("*[name=category_"+i+"]").val();
            }
            _showSpecialty.push(_sMap);
          }
          _request["specialties"] = _showSpecialty;

          $.ajax({
            url: "/api/v1/role/"+vet.id,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(_request),
            cache: false
          }).done(
            delayedCall(function(){
              var hid = window.location.pathname.split("/")[2];
              $.ajax({
                  url: "/api/v1/hospital/" + hid,
                  type: "GET",
                  cache: false
                }).done(function (data) { updateVets(data); });
              }, 500)
          );
      }

    function cancelVet(v, i, vet){
        var _nameCardBtn = v.find("button[data-target=#nameCard_"+i+"]");
        var _nameCard = v.find("#nameCard_"+i);
        var _vetSpecialties = v.find("#vetSpecialties_"+i);
        var _editVet = v.find("#editVet_"+i);
        var _vetCreatePost = v.find("#vet_create_post_"+i);
        var _deleteVet = v.find("#deleteVet_"+i);
        var _saveVet = v.find("#saveVet_"+i);
        var _cancelVet = v.find("#cancelVet_"+i);
        // v.find("input[name=vet_name]").hide();
        v.find("textarea[name=vet_desc]").hide();
        v.find("div[name=edit_exp]").hide();
        v.find("div[name=edit_edu]").hide();
        // v.find("input[name=vet_mail]").hide();
        _vetSpecialties.hide();

        // v.find("input[name=vet_name]").val("");
        v.find("textarea[name=vet_desc]").val("");
        for (var i = 0; i < vet.experience.length+1; i++) {
          v.find("input[name=exp_"+i+"]").val("");
        };
        for (var i = 0; i < vet.education.length+1; i++) {
          v.find("input[name=edu_"+i+"]").val("");
        };
        // v.find("input[name=vet_mail]").val("");
        
        _nameCard.addClass("collapse")
        _nameCardBtn.attr("disabled", false);

        _editVet.show();
        _vetCreatePost.show();
        _deleteVet.show();
        _saveVet.hide();
        _cancelVet.hide();
    }

    function nameSearch() {
        window.location.href = '/hospitals?q=' + $('#name_search').val();
    }

    function showArea(chosenCounty){
      $("#selector_area").empty();
      $("#selector_area").append('<option value="">請選擇</option>');
      for (var area in TW_ZIP[chosenCounty]) {
          var zipCode = TW_ZIP[chosenCounty][area];
         $("#selector_area").append('<option value="' +area+ '">'+ zipCode+" "+ area + '</option>');
      };
    }

    // function displayEr(){
    //     if ($("input[name=er]").is(":checked")) {
    //         $("div[name=erData]").slideDown();
    //     }else{
    //         $("div[name=erData]").slideUp();
    //     }
    // }

    $("#accordion2 a[name=hLists]").click(function(){
      location.href = "/hospitals/edit";
    });
    </script>

  </body>
</html>
